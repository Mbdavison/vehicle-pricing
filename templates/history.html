{% extends "base.html" %}

{% block title %}Sales History · Peak Auto Auctions{% endblock %}

{% block content %}
<div class="peak-card mb-3">
    <div class="peak-card-header">
        <div class="peak-card-title">Sales History</div>
        <div class="text-muted small">
            Showing most recent records (max 1000). Filter by state or company. Click column headers to sort.
        </div>
    </div>

    <form method="get" action="/history" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="state" class="form-label">State</label>
            <select id="state" name="state" class="form-select">
                <option value="">All</option>
                {% for s in states %}
                    <option value="{{ s }}" {% if selected_state == s %}selected{% endif %}>
                        {{ s }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="company" class="form-label">Company</label>
            <select id="company" name="company" class="form-select">
                <option value="">All</option>
                {% for c in companies %}
                    <option value="{{ c }}" {% if selected_company == c %}selected{% endif %}>
                        {{ c }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <button type="submit" class="btn btn-primary">
                Apply Filters
            </button>
        </div>
    </form>
</div>

<div class="peak-card">
    <div class="peak-card-header d-flex justify-content-between align-items-center">
        <div class="peak-card-title">Recent Vehicles ({{ vehicles|length }})</div>
        <div class="text-muted small">Click a column header to sort.</div>
    </div>

    <div class="table-responsive">
        <table id="history-table" class="table table-sm table-striped table-hover">
            <thead>
                <tr>
                    <th data-type="number">ID</th>
                    <th data-type="string">VIN</th>
                    <th data-type="number">Year</th>
                    <th data-type="string">Make</th>
                    <th data-type="string">Model</th>
                    <th data-type="number">Mileage</th>
                    <th data-type="number">Price</th>
                    <th data-type="string">Title</th>
                    <th data-type="string">State</th>
                    <th data-type="string">Company</th>
                    <th data-type="string">Source File</th>
                </tr>
            </thead>
            <tbody>
                {% for v in vehicles %}
                    <tr>
                        <td>{{ v.id }}</td>
                        <td>{{ v.vin }}</td>
                        <td>{{ v.year }}</td>
                        <td>{{ v.make }}</td>
                        <td>{{ v.model }}</td>
                        <td>{{ v.mileage or "" }}</td>
                        <td>{{ v.sale_price or "" }}</td>
                        <td>{{ v.title_status or "" }}</td>
                        <td>{{ v.state or "" }}</td>
                        <td>{{ v.company or "" }}</td>
                        <td>{{ v.source_file or "" }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    /* Small visual hint that headers are clickable */
    #history-table thead th {
        cursor: pointer;
        white-space: nowrap;
    }

    #history-table thead th.sort-asc::after {
        content: " ▲";
        font-size: 0.7rem;
    }

    #history-table thead th.sort-desc::after {
        content: " ▼";
        font-size: 0.7rem;
    }
</style>

<script>
    (function () {
        const table = document.getElementById("history-table");
        if (!table) return;

        const getCellValue = (row, index) => {
            return row.children[index].innerText || row.children[index].textContent;
        };

        const compareValues = (a, b, type, direction) => {
            let v1 = a;
            let v2 = b;

            if (type === "number") {
                const n1 = parseFloat(v1.replace(/[^0-9.\-]/g, "")) || 0;
                const n2 = parseFloat(v2.replace(/[^0-9.\-]/g, "")) || 0;
                return direction * (n1 - n2);
            } else {
                // string compare, case-insensitive
                v1 = v1.toString().toLowerCase();
                v2 = v2.toString().toLowerCase();
                if (v1 < v2) return -1 * direction;
                if (v1 > v2) return 1 * direction;
                return 0;
            }
        };

        const makeSortable = (table) => {
            const headers = table.querySelectorAll("thead th");
            const tbody = table.querySelector("tbody");

            headers.forEach((header, index) => {
                header.addEventListener("click", () => {
                    const type = header.getAttribute("data-type") || "string";

                    // Clear previous sort classes
                    headers.forEach(h => {
                        if (h !== header) {
                            h.classList.remove("sort-asc", "sort-desc");
                        }
                    });

                    // Toggle direction on this header
                    let direction = 1;
                    if (header.classList.contains("sort-asc")) {
                        header.classList.remove("sort-asc");
                        header.classList.add("sort-desc");
                        direction = -1;
                    } else if (header.classList.contains("sort-desc")) {
                        header.classList.remove("sort-desc");
                        header.classList.add("sort-asc");
                        direction = 1;
                    } else {
                        header.classList.add("sort-asc");
                        direction = 1;
                    }

                    const rowsArray = Array.from(tbody.querySelectorAll("tr"));

                    rowsArray.sort((rowA, rowB) => {
                        const a = getCellValue(rowA, index);
                        const b = getCellValue(rowB, index);
                        return compareValues(a, b, type, direction);
                    });

                    // Re-attach rows in sorted order
                    rowsArray.forEach(row => tbody.appendChild(row));
                });
            });
        };

        makeSortable(table);
    })();
</script>

{% endblock %}

