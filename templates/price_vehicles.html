{% extends "base.html" %}

{% block content %}
<h2>Price Vehicles for Purchase</h2>
<p class="small">
    Upload a list of vehicles or enter a single vehicle manually, then calculate recommended offers based on your historical sales.
</p>

{% if error %}
<div class="flash-message flash-error">
    {{ error }}
</div>
{% endif %}

<form method="post" action="/price-vehicles" enctype="multipart/form-data" class="mt-2">
    <div class="flex gap-4 flex-wrap">
        <div class="w-1-2">
            <h3 style="margin-top:0;">Option 1: Upload File</h3>
            <div class="field">
                <label for="file">Pricing File (CSV or Excel)</label>
                <input type="file" id="file" name="file">
            </div>
            <p class="small">
                File should contain columns like VIN, Year, Make, Model, Mileage.
            </p>
        </div>

        <div class="w-1-2">
            <h3 style="margin-top:0;">Option 2: Single Vehicle</h3>
            <div class="field">
                <label for="manual_year">Year</label>
                <input type="number" id="manual_year" name="manual_year">
            </div>
            <div class="field">
                <label for="manual_make">Make</label>
                <input type="text" id="manual_make" name="manual_make">
            </div>
            <div class="field">
                <label for="manual_model">Model</label>
                <input type="text" id="manual_model" name="manual_model">
            </div>
            <div class="field">
                <label for="manual_mileage">Mileage</label>
                <input type="number" id="manual_mileage" name="manual_mileage">
            </div>
            <p class="small">
                Leave the file empty if youâ€™re pricing a single vehicle.
            </p>
        </div>
    </div>

    <hr class="mt-4" style="border:none;border-top:1px solid #e5e7eb;">

    <div class="flex gap-4 flex-wrap mt-3">
        <div class="w-1-2">
            <div class="field">
                <label for="margin">Target Profit Margin (%)</label>
                <input type="number" step="0.1" id="margin" name="margin"
                       value="{{ margin or 20.0 }}">
            </div>
            <div class="field">
                <label for="expenses">Expected Expenses ($)</label>
                <input type="number" step="0.01" id="expenses" name="expenses"
                       value="{{ expenses or 0.0 }}">
            </div>
        </div>

        <div class="w-1-2">
            <div class="field">
                <label for="state">Comps State Filter</label>
                <input type="text" id="state" name="state" value="{{ state or '' }}" placeholder="Optional">
            </div>
            <div class="field">
                <label for="company">Comps Company Filter</label>
                <input type="text" id="company" name="company" value="{{ company or '' }}" placeholder="Optional">
            </div>
            <div class="flex gap-2">
                <div class="field" style="flex:1;">
                    <label for="min_mileage">Comps Min Mileage</label>
                    <input type="number" id="min_mileage" name="min_mileage"
                           value="{{ min_mileage if min_mileage is not none else '' }}">
                </div>
                <div class="field" style="flex:1;">
                    <label for="max_mileage">Comps Max Mileage</label>
                    <input type="number" id="max_mileage" name="max_mileage"
                           value="{{ max_mileage if max_mileage is not none else '' }}">
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit">Calculate Recommended Prices</button>
    </div>
</form>

{% if results %}
<div class="mt-4 flex justify-between" style="align-items:center;">
    <h3 style="margin:0;">Pricing Results</h3>
    <div class="text-right">
        <a class="link" href="/export-pricing-csv">Download CSV</a><br>
        <span class="small">Exports the current results.</span>
    </div>
</div>

<table class="mt-2">
    <thead>
    <tr>
        <th>VIN</th>
        <th>Year</th>
        <th>Make</th>
        <th>Model</th>
        <th>Mileage</th>
        <th>Avg Sale Price</th>
        <th>High Sale Price</th>
        <th>Low Sale Price</th>
        <th>Target Price</th>
        <th>Max Offer</th>
    </tr>
    </thead>
    <tbody>
    {% for r in results %}
    <tr>
        <td>{{ r.vin }}</td>
        <td>{{ r.year }}</td>
        <td>{{ r.make }}</td>
        <td>{{ r.model }}</td>
        <td>{{ r.mileage }}</td>
        <td>
            {% if r.avg_price is not none %}
                ${{ "%.2f"|format(r.avg_price) }}
            {% endif %}
        </td>
        <td>
            {% if r.high_price is not none %}
                ${{ "%.2f"|format(r.high_price) }}
            {% endif %}
        </td>
        <td>
            {% if r.low_price is not none %}
                ${{ "%.2f"|format(r.low_price) }}
            {% endif %}
        </td>
        <td>
            {% if r.target_price is not none %}
                ${{ "%.2f"|format(r.target_price) }}
            {% endif %}
        </td>
        <td>
            {% if r.max_offer is not none %}
                ${{ "%.2f"|format(r.max_offer) }}
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% endif %}
{% endblock %}

